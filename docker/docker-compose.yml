name: lobe-chat-glassmorphism
services:
  postgresql:
    image: pgvector/pgvector:pg16
    container_name: lobe-postgres
    ports:
      - "5432:5432"
    volumes:
      - "./data:/var/lib/postgresql/data"
    environment:
      POSTGRES_DB: lobe
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-lobe_password_secure}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: always

  minio:
    image: minio/minio
    container_name: lobe-minio
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - "./s3_data:/etc/minio/data"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-admin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minio_password_secure}
    command: server /etc/minio/data --address ":9000" --console-address ":9001"
    restart: always

  logto:
    image: svhd/logto:latest
    container_name: lobe-logto
    ports:
      - "3001:3001"
      - "3002:3002"
    depends_on:
      postgresql:
        condition: service_healthy
    environment:
      TRUST_PROXY_HEADER: "1"
      DB_URL: postgresql://postgres:${POSTGRES_PASSWORD:-lobe_password_secure}@postgresql:5432/logto
      ENDPOINT: ${LOGTO_ENDPOINT:-http://localhost:3001}
      ADMIN_ENDPOINT: ${LOGTO_ADMIN_ENDPOINT:-http://localhost:3002}
    entrypoint: ["sh", "-c", "npm run cli db seed -- --swe && npm start"]
    restart: always

  lobe:
    image: lobehub/lobe-chat-database:latest
    container_name: lobe-chat-glass
    expose:
      - "3210"
    depends_on:
      postgresql:
        condition: service_healthy
      minio:
        condition: service_started
      logto:
        condition: service_started
    volumes:
      # Mount custom CSS theme and LegalChat branding
      - ./custom-css/custom.css:/app/public/custom.css:ro
      - ./custom-css/legalchat-branding.js:/app/public/legalchat-branding.js:ro
      - ./custom-css/assets:/app/public/custom-assets:ro
    environment:
      # App URL
      APP_URL: ${APP_URL:-http://localhost:3210}
      NEXTAUTH_URL: ${APP_URL:-http://localhost:3210}
      
      # Database
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD:-lobe_password_secure}@postgresql:5432/lobe
      
      # Auth (Generate with: openssl rand -base64 32)
      NEXT_AUTH_SECRET: ${NEXT_AUTH_SECRET:-your_random_secret_here}
      KEY_VAULTS_SECRET: ${KEY_VAULTS_SECRET:-your_random_secret_here}
      NEXT_AUTH_SSO_PROVIDERS: logto
      AUTH_TRUST_HOST: "true"
      AUTH_LOGTO_ID: ${AUTH_LOGTO_ID:-}
      AUTH_LOGTO_SECRET: ${AUTH_LOGTO_SECRET:-}
      AUTH_LOGTO_ISSUER: ${AUTH_LOGTO_ISSUER:-http://192.168.1.240:3001/oidc}
      
      # S3 Storage (MinIO)
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID:-admin}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY:-minio_password_secure}
      S3_ENDPOINT: ${S3_ENDPOINT:-http://192.168.1.240:9000}
      S3_BUCKET: ${S3_BUCKET:-lobe}
      S3_PUBLIC_DOMAIN: ${S3_PUBLIC_DOMAIN:-http://192.168.1.240:9000}
      S3_ENABLE_PATH_STYLE: "1"
      S3_SET_ACL: ${S3_SET_ACL:-0}
      S3_PREVIEW_URL_EXPIRE_IN: ${S3_PREVIEW_URL_EXPIRE_IN:-1800}

      # Vision hardening: avoid external provider fetches to private URLs
      LLM_VISION_IMAGE_USE_BASE64: ${LLM_VISION_IMAGE_USE_BASE64:-1}
      SSRF_ALLOW_PRIVATE_IP_ADDRESS: ${SSRF_ALLOW_PRIVATE_IP_ADDRESS:-0}
      SSRF_ALLOW_IP_ADDRESS_LIST: ${SSRF_ALLOW_IP_ADDRESS_LIST:-192.168.1.240}
      
      # OpenRouter API (Primary Provider)
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
      OPENROUTER_PROXY_URL: https://openrouter.ai/api/v1
      
      # Make OpenRouter the default provider
      DEFAULT_AGENT_CONFIG: "provider=openrouter;model=openai/gpt-4o-mini"
      
      # Optional: Additional providers
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}
      
      # Custom Theme
      NEXT_PUBLIC_CUSTOM_THEME: "true"
      
    restart: always

  login-proxy:
    image: node:20-alpine
    container_name: lobe-login-proxy
    ports:
      - "3210:3210"
      - "3211:3210"
    volumes:
      - ./login-fix/server.js:/app/server.js:ro
    working_dir: /app
    command: ["node", "server.js"]
    environment:
      LOBECHAT_HOST: lobe-chat-glass
      LOBECHAT_PORT: 3210
      APP_PUBLIC_URL: ${APP_URL:-http://localhost:3210}
      PORT: 3210
      LEGALCHAT_APP_NAME: ${LEGALCHAT_APP_NAME:-LegalChat}
      LEGALCHAT_DEFAULT_AGENT_NAME: ${LEGALCHAT_DEFAULT_AGENT_NAME:-George}
      LEGALCHAT_AVATAR_URL: ${LEGALCHAT_AVATAR_URL:-/custom-assets/george-avatar.jpg}
      LEGALCHAT_ASSISTANT_ROLE_DE: ${LEGALCHAT_ASSISTANT_ROLE_DE:-persönlicher KI-Jurist}
      LEGALCHAT_ASSISTANT_ROLE_EN: ${LEGALCHAT_ASSISTANT_ROLE_EN:-personal AI legal assistant}
      LEGALCHAT_WELCOME_PRIMARY_DE: ${LEGALCHAT_WELCOME_PRIMARY_DE:-Ich bin George, Ihr persönlicher KI-Jurist bei LegalChat. Wie kann ich Ihnen jetzt helfen?}
      LEGALCHAT_WELCOME_PRIMARY_EN: ${LEGALCHAT_WELCOME_PRIMARY_EN:-}
      LEGALCHAT_WELCOME_SECONDARY_DE: ${LEGALCHAT_WELCOME_SECONDARY_DE:-Wenn Sie einen professionelleren oder maßgeschneiderten Assistenten benötigen, klicken Sie auf +, um einen benutzerdefinierten Assistenten zu erstellen.}
      LEGALCHAT_WELCOME_SECONDARY_EN: ${LEGALCHAT_WELCOME_SECONDARY_EN:-}
    depends_on:
      - lobe
    restart: always

volumes:
  data:
    driver: local
  s3_data:
    driver: local
